<!-- 
    统计徽章组件片段
    包含：浏览量、点赞数、评论数等统计信息
-->

<!-- 浏览量徽章 -->
<span th:fragment="viewBadge(count, theme)" 
      th:class="${theme == 'overlay' ? 'stat-badge bg-black/40 text-white backdrop-blur-sm' : 'stat-badge-view'}"
      th:title="|浏览量: ${count}|">
    <svg class="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" 
              d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"/>
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" 
              d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"/>
    </svg>
    <span th:text="${@themeUtils.formatNumber(count)}">0</span>
</span>

<!-- 点赞徽章 -->
<button th:fragment="likeBadge(count, postId, theme)" 
        th:class="${theme == 'overlay' ? 'stat-badge bg-black/40 text-white backdrop-blur-sm hover:bg-black/60' : 'stat-badge-like'}"
        th:title="|点赞数: ${count}|"
        th:data-post-id="${postId}"
        th:data-like-count="${count}"
        x-data="{ 
          liked: false, 
          count: [[${count}]],
          loading: false
        }"
        x-on:click.stop="handleLike()"
        :disabled="loading">
    <svg class="w-3.5 h-3.5 transition-transform duration-200"
         :class="{ 'scale-110': liked, 'text-danger fill-current': liked }">
        <path stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" 
              :fill="liked ? 'currentColor' : 'none'"
              d="M4.318 6.318a4.5 4.5 0 000 6.364L12 20.364l7.682-7.682a4.5 4.5 0 00-6.364-6.364L12 7.636l-1.318-1.318a4.5 4.5 0 00-6.364 0z"/>
    </svg>
    <span x-text="window.AkinaZZZ?.utils?.formatNumber(count) || count">[[${@themeUtils.formatNumber(count)}]]</span>
    
    <script>
        function handleLike() {
            if (this.loading) return;
            
            this.loading = true;
            
            // 乐观更新UI
            const previousLiked = this.liked;
            const previousCount = this.count;
            
            this.liked = !this.liked;
            this.count += this.liked ? 1 : -1;
            
            // 调用点赞API
            if (window.AkinaZZZ?.modules?.like) {
                window.AkinaZZZ.modules.like.toggle('[[${postId}]]', this.liked)
                    .then((result) => {
                        // 更新实际数据
                        this.count = result.count;
                        this.liked = result.liked;
                    })
                    .catch((error) => {
                        console.error('Like operation failed:', error);
                        // 回滚UI状态
                        this.liked = previousLiked;
                        this.count = previousCount;
                        
                        // 显示错误提示
                        if (window.AkinaZZZ?.utils?.showNotification) {
                            window.AkinaZZZ.utils.showNotification('操作失败，请稍后重试', 'error');
                        }
                    })
                    .finally(() => {
                        this.loading = false;
                    });
            } else {
                // 如果没有like模块，回滚状态
                setTimeout(() => {
                    this.liked = previousLiked;
                    this.count = previousCount;
                    this.loading = false;
                }, 300);
            }
        }
    </script>
</button>

<!-- 评论数徽章 -->
<span th:fragment="commentBadge(count, theme)" 
      th:class="${theme == 'overlay' ? 'stat-badge bg-black/40 text-white backdrop-blur-sm' : 'stat-badge-view'}"
      th:title="|评论数: ${count}|">
    <svg class="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" 
              d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z"/>
    </svg>
    <span th:text="${@themeUtils.formatNumber(count)}">0</span>
</span>

<!-- 收藏数徽章 -->
<button th:fragment="bookmarkBadge(count, postId, theme)" 
        th:class="${theme == 'overlay' ? 'stat-badge bg-black/40 text-white backdrop-blur-sm hover:bg-black/60' : 'stat-badge bg-dark-200/50 text-dark-600 hover:bg-dark-200 hover:text-accent'}"
        th:title="|收藏数: ${count}|"
        th:data-post-id="${postId}"
        th:data-bookmark-count="${count}"
        x-data="{ 
          bookmarked: false, 
          count: [[${count}]],
          loading: false
        }"
        x-on:click.stop="handleBookmark()"
        :disabled="loading">
    <svg class="w-3.5 h-3.5 transition-all duration-200"
         :class="{ 'text-accent': bookmarked }">
        <path stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" 
              :fill="bookmarked ? 'currentColor' : 'none'"
              d="M5 5a2 2 0 012-2h10a2 2 0 012 2v16l-7-3.5L5 21V5z"/>
    </svg>
    <span x-text="window.AkinaZZZ?.utils?.formatNumber(count) || count">[[${@themeUtils.formatNumber(count)}]]</span>
    
    <script>
        function handleBookmark() {
            if (this.loading) return;
            
            this.loading = true;
            
            // 乐观更新UI
            const previousBookmarked = this.bookmarked;
            const previousCount = this.count;
            
            this.bookmarked = !this.bookmarked;
            this.count += this.bookmarked ? 1 : -1;
            
            // 调用收藏API
            if (window.AkinaZZZ?.modules?.bookmark) {
                window.AkinaZZZ.modules.bookmark.toggle('[[${postId}]]', this.bookmarked)
                    .then((result) => {
                        this.count = result.count;
                        this.bookmarked = result.bookmarked;
                    })
                    .catch((error) => {
                        console.error('Bookmark operation failed:', error);
                        // 回滚UI状态
                        this.bookmarked = previousBookmarked;
                        this.count = previousCount;
                        
                        if (window.AkinaZZZ?.utils?.showNotification) {
                            window.AkinaZZZ.utils.showNotification('操作失败，请稍后重试', 'error');
                        }
                    })
                    .finally(() => {
                        this.loading = false;
                    });
            } else {
                // 回滚状态
                setTimeout(() => {
                    this.bookmarked = previousBookmarked;
                    this.count = previousCount;
                    this.loading = false;
                }, 300);
            }
        }
    </script>
</button>

<!-- 分享徽章 -->
<button th:fragment="shareBadge(url, title, theme)" 
        th:class="${theme == 'overlay' ? 'stat-badge bg-black/40 text-white backdrop-blur-sm hover:bg-black/60' : 'stat-badge bg-dark-200/50 text-dark-600 hover:bg-dark-200'}"
        th:title="分享文章"
        th:data-share-url="${url}"
        th:data-share-title="${title}"
        x-on:click.stop="handleShare()"
        x-data="{ loading: false }"
        :disabled="loading">
    <svg class="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" 
              d="M8.684 13.342C8.886 12.938 9 12.482 9 12c0-.482-.114-.938-.316-1.342m0 2.684a3 3 0 110-2.684m0 2.684l6.632 3.316m-6.632-6l6.632-3.316m0 0a3 3 0 105.367-2.684 3 3 0 00-5.367 2.684zm0 9.316a3 3 0 105.367 2.684 3 3 0 00-5.367-2.684z"/>
    </svg>
    <span>分享</span>
    
    <script>
        function handleShare() {
            if (this.loading) return;
            
            const shareUrl = '[[${url}]]';
            const shareTitle = '[[${title}]]';
            
            // 使用Web Share API（如果支持）
            if (navigator.share) {
                this.loading = true;
                navigator.share({
                    title: shareTitle,
                    url: shareUrl
                }).then(() => {
                    if (window.AkinaZZZ?.utils?.showNotification) {
                        window.AkinaZZZ.utils.showNotification('分享成功！', 'success');
                    }
                }).catch((error) => {
                    if (error.name !== 'AbortError') {
                        console.error('Share failed:', error);
                        this.fallbackShare();
                    }
                }).finally(() => {
                    this.loading = false;
                });
            } else {
                this.fallbackShare();
            }
        }
        
        function fallbackShare() {
            // 降级到复制链接
            const shareUrl = '[[${url}]]';
            
            if (navigator.clipboard) {
                navigator.clipboard.writeText(window.location.origin + shareUrl).then(() => {
                    if (window.AkinaZZZ?.utils?.showNotification) {
                        window.AkinaZZZ.utils.showNotification('链接已复制到剪贴板', 'success');
                    }
                });
            } else {
                // 最终降级方案
                const textarea = document.createElement('textarea');
                textarea.value = window.location.origin + shareUrl;
                document.body.appendChild(textarea);
                textarea.select();
                document.execCommand('copy');
                document.body.removeChild(textarea);
                
                if (window.AkinaZZZ?.utils?.showNotification) {
                    window.AkinaZZZ.utils.showNotification('链接已复制到剪贴板', 'success');
                }
            }
        }
    </script>
</button>

<!-- 综合统计条 -->
<div th:fragment="statsRow(post, theme)" 
     class="flex items-center space-x-3">
    <div th:replace="~{_fragments/stat-badge :: viewBadge(count=${post.status.visit ?: 0}, theme=${theme})}"></div>
    <div th:replace="~{_fragments/stat-badge :: likeBadge(count=${post.status.like ?: 0}, postId=${post.metadata.name}, theme=${theme})}"></div>
    <div th:replace="~{_fragments/stat-badge :: commentBadge(count=${post.status.comment ?: 0}, theme=${theme})}"></div>
    <div th:replace="~{_fragments/stat-badge :: bookmarkBadge(count=${post.status.bookmark ?: 0}, postId=${post.metadata.name}, theme=${theme})}"></div>
    <div th:replace="~{_fragments/stat-badge :: shareBadge(url=${'/posts/' + post.status.slug}, title=${post.spec.title}, theme=${theme})}"></div>
</div>

<!-- 简化统计条（只显示关键指标） -->
<div th:fragment="statsRowSimple(post, theme)" 
     class="flex items-center space-x-3">
    <div th:replace="~{_fragments/stat-badge :: viewBadge(count=${post.status.visit ?: 0}, theme=${theme})}"></div>
    <div th:replace="~{_fragments/stat-badge :: likeBadge(count=${post.status.like ?: 0}, postId=${post.metadata.name}, theme=${theme})}"></div>
    <div th:if="${(post.status.comment ?: 0) > 0}" 
         th:replace="~{_fragments/stat-badge :: commentBadge(count=${post.status.comment}, theme=${theme})}"></div>
</div>